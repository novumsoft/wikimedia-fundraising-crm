<?php

require_once __DIR__ . '/BaseTestCase.php';
require_once __DIR__ . '/../includes/Message.php';

class PaypalRecurringTest extends BaseTestCase {
    public static function getInfo() {
        return array(
            'name' => 'PayPal recurring',
            'group' => 'Donations Pipeline',
            'description' => 'Process recurring messages',
        );
    }

    public function setUp() {
        parent::setUp();

        $this->subscr_id = mt_rand();
        $this->amount = '2.01';

        $this->subscription_message = new TransactionMessage( array(
            'txn_type' => 'subscr_signup',
            'subscr_id' => $this->subscr_id,
            'original_gross' => $this->amount,
            'gross' => $this->amount,
            'amount' => $this->amount,
            'frequency_unit' => 'month',
            'frequency_interval' => '1',
            'installments' => '10',
            'create_date' => strtotime( '2000-01-01 00:01:02' ),
            'start_date' => strtotime( '2000-01-01 01:02:03' ),
        ) );

        $this->payment_message = new TransactionMessage( array(
            'txn_type' => 'subscr_payment',
            'subscr_id' => $this->subscr_id,
            'original_gross' => $this->amount,
            'gross' => $this->amount,
            'payment_date' => strtotime( "2000-02-01 01:02:03" ),
        ) );

        $this->expire_message = new TransactionMessage( array(
            'txn_type' => 'subscr_eot',
            'subscr_id' => $this->subscr_id,
        ) );

        $this->cancel_message = new TransactionMessage( array(
            'txn_type' => 'subscr_cancel',
            'subscr_id' => $this->subscr_id,
            'cancel_date' => strtotime( '2000-04-01 00:01:02' ),
        ) );

        $this->failed_message = new TransactionMessage( array(
            'txn_type' => 'subscr_failed',
            'subscr_id' => $this->subscr_id,
            'failure_count' => '3',
            'failure_retry_date' => strtotime( '2000-05-01 00:01:02' ),
        ) );

        //TODO: modification messages are not processed currently

        $this->existing_subscr_id = mt_rand();

        $this->existing_contrib_message_body = array(
            'subscr_id' => $this->existing_subscr_id,
            'payment_date' => wmf_common_date_unix_to_civicrm( time() ),
            'txn_type' => 'subscr_payment',
        );

        $api = civicrm_api_classapi();

        $api->Contact->Create( array(
            'contact_type' => 'Individual',
            'email' => 'foo@example.com',
            'version' => 3,
        ) );
        $this->contact_id = $api->id;

        $api->ContributionRecur->Create( array(
            'contact_id' => $this->contact_id,
            'frequency_interval' => 1,
            'trxn_id' => $this->existing_subscr_id,
            'version' => 3,
        ) );
        $this->existing_recur_id = $api->id;

        $api->Contribution->Create( array(
            'contact_id' => $this->contact_id,
            'contribution_type' => 'Cash',
            'contribution_recur_id' => $this->existing_recur_id,
            'total_amount' => '20.01',
            'version' => 3,
        ) );
        $this->existing_contribution_id = $api->id;

        $this->ctid = wmf_civicrm_insert_contribution_tracking( 'foo', 'web', time(), $this->existing_contribution_id, true, true );
    }

    public function tearDown() {
        $api = civicrm_api_classapi();

        $api->ContributionRecur->Delete( array(
            'id' => $this->existing_recur_id,
            'version' => 3,
        ) );

        $api->Contribution->Delete( array(
            'id' => $this->existing_contribution_id,
            'version' => 3,
        ) );

        parent::tearDown();
    }

    public function testNormalPayment() {
        recurring_import( $this->subscription_message );
        recurring_import( $this->payment_message );

        $payment_data = $this->payment_message->getBody();

        $contributions = wmf_civicrm_get_contributions_from_gateway_id( $payment_data['gateway'], $payment_data['gateway_txn_id'] );
        $recur_record = wmf_civicrm_get_recur_record( $this->subscr_id );
        //FIXME: convert to array

        $this->verbose( json_encode( $contributions ) );
        $this->assertSuperset( $contributions, array(
            array(
                'original_amount' => $this->amount,
                'contribution_recur_id' => $recur_record->id,
            ),
        ) );

        $this->verbose( json_encode( $recur_record ) );
        $this->assertSuperset( get_object_vars( $recur_record ), array(
            'amount' => $this->amount,
            'next_sched_contribution' => '2000-03-01 01:02:03',
            'frequency_interval' => '1',
            'frequency_unit' => 'month',
            'cycle_day' => '1',
            'create_date' => '2000-01-01 00:01:02',
            'start_date' => '2000-01-01 01:02:03',
            'end_date' => null,
            'installments' => '10',
            'trxn_id' => (string)$this->subscr_id,
        ) );
    }

    public function testNoSubscription() {
        try {
            recurring_import( $this->payment_message );
            $this->fail( "should have gotten a RequeueError." );
        } catch ( RequeueError $ex ) {
            // good.
        }
    }

    public function testExpire() {
        recurring_import( $this->subscription_message );
        recurring_import( $this->expire_message );

        $recur_record = wmf_civicrm_get_recur_record( $this->subscr_id );
        $this->assertNotNull( $recur_record->end_date );
    }

    public function testCancel() {
        recurring_import( $this->subscription_message );
        recurring_import( $this->cancel_message );

        $recur_record = wmf_civicrm_get_recur_record( $this->subscr_id );
        $this->assertSuperset( get_object_vars( $recur_record ), array(
            'end_date' => '2000-04-01 00:01:02',
            'cancel_date' => '2000-04-01 00:01:02',
        ) );
    }

    public function testFailed() {
        recurring_import( $this->subscription_message );
        recurring_import( $this->failed_message );

        $recur_record = wmf_civicrm_get_recur_record( $this->subscr_id );
        $this->assertSuperset( get_object_vars( $recur_record ), array(
            'failure_count' => '3',
            'failure_retry_date' => '2000-05-01 00:01:02',
        ) );
    }

    public function testRecurring_get_contribution_tracking_idFromPrevious() {
        $ctid = recurring_get_contribution_tracking_id( $this->existing_contrib_message_body );
        $this->assertEqual( $this->ctid, $ctid,
            "Contribution tracking can be looked up from msg.subscr_id" );
    }
}
